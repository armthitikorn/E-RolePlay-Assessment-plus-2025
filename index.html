<script type="module">
    // ✅ ใช้ Import แบบเสถียร
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
    
    const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno';
    const supabase = createClient(supabaseUrl, supabaseKey);

    function showMessage(text, isError = false) {
      const messageBox = document.getElementById('messageBox');
      messageBox.textContent = text;
      messageBox.style.display = 'block';
      messageBox.className = isError ? 'alert alert-danger mt-3' : 'alert alert-success mt-3';
    }

    function loginAndRedirect(email) {
      localStorage.setItem('userEmail', email);
      localStorage.setItem('isLoggedIn', 'true');
      showMessage('กำลังเข้าสู่ระบบ... โปรดรอสักครู่', false);
      setTimeout(() => {
        window.location.href = "e-roleplay.html";
      }, 1500);
    }

    document.addEventListener('DOMContentLoaded', () => {
      // ตรวจสอบว่าล็อกอินค้างไว้หรือไม่
      if (localStorage.getItem('isLoggedIn') === 'true') {
         window.location.href = "e-roleplay.html";
         return;
      }

      const form = document.getElementById('registerForm');
      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const name = document.getElementById('name').value;
        const email = document.getElementById('email').value;
        const department = document.getElementById('department').value;

        if (!email) {
          showMessage('กรุณากรอกอีเมล', true);
          return;
        }

        showMessage('กำลังเชื่อมต่อฐานข้อมูล...', false);

        try {
          // ✅ 1. แก้ไข: เปลี่ยนจาก 'users' เป็น 'submissions'
          const { data: existingUser, error: selectError } = await supabase
            .from('submissions') // <--- แก้ตรงนี้ครับ
            .select('*')
            .eq('email', email)
            .maybeSingle(); 

          if (selectError) {
             throw new Error(`Select Error: ${selectError.message}`);
          }

          if (existingUser) {
            showMessage('พบข้อมูลเดิม! กำลังพาคุณไปทำแบบทดสอบ...', false);
            loginAndRedirect(email);
            return;
          }

          // ✅ 2. แก้ไข: เปลี่ยนจาก 'users' เป็น 'submissions'
          const { error: insertError } = await supabase
            .from('submissions') // <--- แก้ตรงนี้ครับ
            .insert([
              { 
                email: email, 
                full_name: name, // ⚠️ อย่าลืมเช็คว่าในตาราง submissions คอลัมน์ชื่อ full_name หรือ name นะครับ
                department: department 
              }
            ]);

          if (insertError) {
             throw new Error(`Insert Error: ${insertError.message}`);
          }

          showMessage('ลงทะเบียนใหม่สำเร็จ! กำลังพาคุณไปทำแบบทดสอบ...', false);
          loginAndRedirect(email);

        } catch (err) {
          console.error('Error:', err);
          showMessage(`เกิดข้อผิดพลาด: ${err.message}`, true);
        }
      });
    });
  </script>
